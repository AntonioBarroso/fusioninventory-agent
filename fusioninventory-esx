#!/usr/bin/perl

use strict;
use warnings;

use FusionInventory::Agent::Task::ESX;

use Getopt::Long;

my $args = {};

GetOptions(
        $args, 'host=s', 'user=s', 'password=s', 'directory=s'
        );

usage() unless $args->{host} and $args->{user} and $args->{password} and $args->{directory};

sub usage {

    print STDERR <<EOF;

    A command line tool to create .ocs file from an ESX server.

        USAGE:
        --host hostname        : hostname is the hostname of the IP address of the ESX server
        --user username        : the ESX user name
        --password xxxx        : the ESX password
        --directory /somewhere : the location where the .ocs file must be written

        EXAMPLE:
        $0 --host myesx --user foo --password bar --directory /tmp

        You can import the .ocs file in your inventory server with the fusioninventory-injector tool.

        The .ocs file can be imported in the following servers:
        - ocsinventory
        - GLPI using the FusionInventory for GLPI plugin
        - Uranos

        This tool is part of the FusionInventory distribution.
EOF

        exit(1);
}

use FusionInventory::Agent::Task::ESX;

my $esx = FusionInventory::Agent::Task::ESX->new({
    config => {
        local => $args->{directory}
    }
});

$esx->connect({
            addr => $args->{host},
            login => $args->{user},
            passwd => $args->{password},
            });

my $hostIds = $esx->getHostIds();
foreach my $hostId (@$hostIds) {
    my $inventory = $esx->createInventory($hostId);

    $inventory->writeXML();
}
